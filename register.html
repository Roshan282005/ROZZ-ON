<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | ‚ÑùùïÄ‚Ñ§‚Ñ§</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>

<body class="flex items-center justify-center min-h-screen bg-gradient-to-r from-purple-700 to-indigo-700">

    <!-- Container -->
    <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg">
        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Welcome to ‚ÑùùïÄ‚Ñ§‚Ñ§ Auth</h2>

        <!-- LOGIN FORM -->
        <form id="loginForm" class="space-y-4">
            <div class="relative">
                <i class="fas fa-envelope absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="email" id="loginEmail" placeholder="Email" required
                    class="w-full pl-10 pr-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>

            <div class="relative">
                <i class="fas fa-lock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="password" id="loginPassword" placeholder="Password" required
                    class="w-full pl-10 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                <i class="fas fa-eye absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 cursor-pointer opacity-70"
                    id="toggleLoginPassword"></i>
            </div>

            <button type="submit"
                class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition">Login</button>

            <!-- Google Login -->
            <button type="button" id="googleLoginBtn"
                class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 flex items-center justify-center">
                <i class="fab fa-google mr-2"></i> Sign in with Google
            </button>
        </form>

        <p class="text-center text-sm text-gray-600 mt-4">Don‚Äôt have an account?
            <a href="#" onclick="toggleForm()" class="text-indigo-600 font-semibold">Register</a>
        </p>

        <!-- REGISTER FORM (Hidden Initially) -->
        <form id="registerForm" class="space-y-4 hidden mt-6">
            <div class="relative">
                <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="fName" placeholder="First Name" required
                    class="w-full pl-10 pr-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>

            <div class="relative">
                <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="lName" placeholder="Last Name" required
                    class="w-full pl-10 pr-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>

            <div class="relative">
                <i class="fas fa-envelope absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="email" id="registerEmail" placeholder="Email" required
                    class="w-full pl-10 pr-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>

            <div class="relative">
                <i class="fas fa-lock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="password" id="registerPassword" placeholder="Password" required
                    class="w-full pl-10 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                <i class="fas fa-eye absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 cursor-pointer opacity-70"
                    id="toggleRegisterPassword"></i>
            </div>

            <button type="submit"
                class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">Register</button>

            <p class="text-center text-sm text-gray-600 mt-4">Already have an account?
                <a href="#" onclick="toggleForm()" class="text-indigo-600 font-semibold">Login</a>
            </p>
        </form>
    </div>

    <!-- Firebase -->
    <script type="module">
        // Change API_URL to local backend for testing
        const API_URL = "http://localhost/rizz"; // Updated to local backend URL

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDoIAiSnBx8GGNhjQkEB7j1bANx7k2l8dc",
            authDomain: "rizzauthapp.firebaseapp.com",
            projectId: "rizzauthapp",
            storageBucket: "rizzauthapp.appspot.com",
            messagingSenderId: "607508317395",
            appId: "1:607508317395:web:f2f403d10915d6d2ef4026",
            measurementId: "G-2YQFBWK95F"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // Toggle forms
        window.toggleForm = function () {
            document.getElementById("loginForm").classList.toggle("hidden");
            document.getElementById("registerForm").classList.toggle("hidden");
        };

        // Toggle password visibility
        function setupPasswordToggle(toggleId, inputId) {
            const toggle = document.getElementById(toggleId);
            const input = document.getElementById(inputId);
            toggle.addEventListener("click", () => {
                input.type = input.type === "password" ? "text" : "password";
                toggle.classList.toggle("fa-eye-slash");
            });
        }
        setupPasswordToggle("toggleLoginPassword", "loginPassword");
        setupPasswordToggle("toggleRegisterPassword", "registerPassword");

        // Register
        document.getElementById("registerForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const fName = document.getElementById("fName").value;
            const lName = document.getElementById("lName").value;
            const email = document.getElementById("registerEmail").value;
            const password = document.getElementById("registerPassword").value;

            try {
                const result = await createUserWithEmailAndPassword(auth, email, password);
                const user = result.user;

                await fetch(`${API_URL}/login/signup.php`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        uid: user.uid,
                        email,
                        first_name: fName,
                        last_name: lName
                    })
                });

                alert("Signup successful!");
                window.location.href = "index.html";
            } catch (err) {
                alert("Signup error: " + err.message);
            }
        });

        // Login
        document.getElementById("loginForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;

            try {
                const result = await signInWithEmailAndPassword(auth, email, password);
                const user = result.user;

                const formData = new FormData();
                formData.append("uid", user.uid);
                formData.append("email", user.email);
                formData.append("name", user.displayName || "Manual User");

                await fetch(`${API_URL}/login/track-login.php`, {
                    method: "POST",
                    body: formData
                });

                alert("Welcome back!");
                window.location.href = "index.html";
            } catch (err) {
                alert("Login failed: " + err.message);
            }
        });

        // Google Login
        document.getElementById("googleLoginBtn").addEventListener("click", async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                // Extract names safely
                const [first_name, ...rest] = user.displayName?.split(" ") ?? ["Google"];
                const last_name = rest.join(" ") || "";

                // Save user to backend
                console.log("Sending user data to backend:", {
                    uid: user.uid,
                    email: user.email,
                    first_name,
                    last_name
                });
                const response = await fetch(`${API_URL}/login/save-user.php`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    mode: "cors", // ‚úÖ ensure CORS
                    body: JSON.stringify({
                        uid: user.uid,
                        email: user.email,
                        first_name,
                        last_name
                    })
                });

                console.log("Fetch response status:", response.status);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Backend error response:", errorText);
                    throw new Error(`Backend returned ${response.status}`);
                }

                const data = await response.json().catch(() => null);
                console.log("Backend response:", data);

                alert("Google login successful! Welcome " + user.displayName);
                window.location.href = "index.html";

            } catch (err) {
                console.error("Google Sign-In Failed:", err);
                alert("Google login failed: " + err.message);
            }
        });

    </script>
</body>

</html>